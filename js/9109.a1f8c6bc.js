(self.webpackChunkblog=self.webpackChunkblog||[]).push([[9109],{19109:(n,e,t)=>{"use strict";t.r(e),t.d(e,{default:()=>l});var r=t(59713),i=t.n(r),o=t(6479),c=t.n(o),p=(t(67294),t(3905));function a(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function u(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?a(Object(t),!0).forEach((function(e){i()(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}var s={};function l(n){var e=n.components,t=c()(n,["components"]);return(0,p.kt)("wrapper",u(u(u({},s),t),{},{components:e,mdxType:"MDXLayout"}),(0,p.kt)("h3",null,"计算公式"),(0,p.kt)("pre",null,(0,p.kt)("code",u({parentName:"pre"},{className:"language-js"}),"const MAX_SIGNED_31_BIT_INT = Math.pow(2, 30) - 1\n\nexport const NoWork = 0;\nexport const Never = 1;\n\nconst UNIT_SIZE = 10;\nconst MAGIC_NUMBER_OFFSET = MAX_SIGNED_31_BIT_INT - 1;\n\n// 1 unit of expiration time represents 10ms.\nexport function msToExpirationTime(ms) {\n  // Always add an offset so that we don't clash with the magic number for NoWork.\n  return MAGIC_NUMBER_OFFSET - ((ms / UNIT_SIZE) | 0);\n}\n\nexport function expirationTimeToMs(expirationTime) {\n  return (MAGIC_NUMBER_OFFSET - expirationTime) * UNIT_SIZE;\n}\n\nfunction ceiling(num, precision) {\n  return (((num / precision) | 0) + 1) * precision;\n}\n\nfunction computeExpirationBucket(currentTime, expirationInMs, bucketSizeMs) {\n  return (\n    MAGIC_NUMBER_OFFSET -\n    ceiling(\n      MAGIC_NUMBER_OFFSET - currentTime + expirationInMs / UNIT_SIZE,\n      bucketSizeMs / UNIT_SIZE,\n    )\n  );\n}\n\nexport const LOW_PRIORITY_EXPIRATION = 5000;\nexport const LOW_PRIORITY_BATCH_SIZE = 250;\n\nexport function computeAsyncExpiration(currentTime) {\n  return computeExpirationBucket(\n    currentTime,\n    LOW_PRIORITY_EXPIRATION,\n    LOW_PRIORITY_BATCH_SIZE,\n  );\n}\n\nexport const HIGH_PRIORITY_EXPIRATION = __DEV__ ? 500 : 150;\nexport const HIGH_PRIORITY_BATCH_SIZE = 100;\n\nexport function computeInteractiveExpiration(currentTime) {\n  return computeExpirationBucket(\n    currentTime,\n    HIGH_PRIORITY_EXPIRATION,\n    HIGH_PRIORITY_BATCH_SIZE,\n  );\n}\n")),(0,p.kt)("p",null,(0,p.kt)("inlineCode",{parentName:"p"},"computeAsyncExpiration")," 函数化简后得到如下公式, 针对这个公式目前的心得如下:"),(0,p.kt)("ol",null,(0,p.kt)("li",{parentName:"ol"},"抹平传入的 ",(0,p.kt)("inlineCode",{parentName:"li"},"bucketSizeMs")," 精度误差, 为 batch 作准备;"),(0,p.kt)("li",{parentName:"ol"},(0,p.kt)("inlineCode",{parentName:"li"},"currentTime")," 越大, 相应的 ",(0,p.kt)("inlineCode",{parentName:"li"},"expirationTime")," 的结果如下图所示;")),(0,p.kt)("p",null,(0,p.kt)("img",u({parentName:"p"},{src:"http://with.muyunyun.cn/16a5237163f1e4f2967711442ec03a4c.jpg-200",alt:null}))),(0,p.kt)("pre",null,(0,p.kt)("code",u({parentName:"pre"},{className:"language-js"}),"const MAX_SIGNED_31_BIT_INT = Math.pow(2, 30) - 1\nconst MAGIC_NUMBER_OFFSET = MAX_SIGNED_31_BIT_INT - 1;\n\nfunction ceiling(num, precision) {\n  return (((num / precision) | 0) + 1) * precision;\n}\n\nfunction computeExpirationBucket(currentTime) {\n  return (\n    MAGIC_NUMBER_OFFSET -\n    ceiling(\n      MAGIC_NUMBER_OFFSET - currentTime + 500,\n      25,\n    )\n  );\n}\n")),(0,p.kt)("p",null,(0,p.kt)("inlineCode",{parentName:"p"},"ceiling")," 函数的作用: 根据 ",(0,p.kt)("inlineCode",{parentName:"p"},"precision")," 的精度取值"),(0,p.kt)("pre",null,(0,p.kt)("code",u({parentName:"pre"},{className:"language-js"}),"ceiling(25, 25) // 50\nceiling(26, 25) // 50\nceiling(27, 25) // 50\n...\nceiling(49, 25) // 50\nceiling(50, 25) // 75\nceiling(51, 25) // 75\n")))}l.isMDXComponent=!0}}]);