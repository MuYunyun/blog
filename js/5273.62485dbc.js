(self.webpackChunkblog=self.webpackChunkblog||[]).push([[5273],{65273:(n,e,t)=>{"use strict";t.r(e),t.d(e,{default:()=>o});var l=t(59713),a=t.n(l),u=t(6479),r=t.n(u),c=(t(67294),t(3905));function s(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(n);e&&(l=l.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,l)}return t}function p(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?s(Object(t),!0).forEach((function(e){a()(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}var m={};function o(n){var e=n.components,t=r()(n,["components"]);return(0,c.kt)("wrapper",p(p(p({},m),t),{},{components:e,mdxType:"MDXLayout"}),(0,c.kt)("h3",null,"Https 域名配置"),(0,c.kt)("p",null,"免费的 Https 证书，最多只有一年的期限，而且每个二级子域名要单独申请，很浪费时间。使用本文提供的方法，可以只配置一次，实现证书永久自动续期。"),(0,c.kt)("blockquote",null,(0,c.kt)("p",{parentName:"blockquote"},"由于域名并没有备案，因此笔者将域名端口挂在非 80 端口(90)上，非 80 的端口笔者尝试配置 Https 服务并未成功，后续如有需求继续调研。")),(0,c.kt)("h3",null,"acme.sh 安装实践"),(0,c.kt)("p",null,"笔者一开始将 acme.sh 安装在树莓派中，绕了弯。",(0,c.kt)("strong",{parentName:"p"},"应将 acme.sh 安装在云服务器端"),"。"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"步骤一: 安装 acme.sh")),(0,c.kt)("blockquote",null,(0,c.kt)("p",{parentName:"blockquote"},(0,c.kt)("a",p({parentName:"p"},{href:"https://github.com/acmesh-official/acme.sh/wiki/sudo"}),"https://github.com/acmesh-official/acme.sh/wiki/sudo"))),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"# unstall for current user\nacme.sh --uninstall\n\n# change to root(需要执行)\nsudo su\n\n# install again for root user\ncurl https://get.acme.sh | sh -s email=328375795@qq.com\nsource ~/.bashrc\n")),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"步骤二: 获取 https 证书")),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"acme.sh --set-default-ca --server letsencrypt\nacme.sh --issue -d www.muyunyun.cn --nginx\n")),(0,c.kt)("p",null,"todo: 移除 "),(0,c.kt)("p",null,(0,c.kt)("img",p({parentName:"p"},{src:"http://with.muyunyun.cn/3e990527ed80cb020704ab30aa502856.jpg-400",alt:null}))),(0,c.kt)("p",null,"在这一步中 acme.sh 读取了 nginx 配置，并自动生成了证书。"),(0,c.kt)("blockquote",null,(0,c.kt)("p",{parentName:"blockquote"},"调试方法: acme.sh --issue -d ",(0,c.kt)("a",p({parentName:"p"},{href:"http://www.muyunyun.cn"}),"www.muyunyun.cn")," --nginx --debug 2")),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"步骤三: 将证书拷贝到 ",(0,c.kt)("inlineCode",{parentName:"li"},"/etc/nginx/ssl")," 文件夹。")),(0,c.kt)("p",null,"创建文件夹"),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"mkdir -p /etc/nginx/ssl/www.muyunyun.cn\n")),(0,c.kt)("p",null,"拷贝证书:"),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),'acme.sh --install-cert -d www.muyunyun.cn \\\n--key-file       /etc/nginx/ssl/www.muyunyun.cn/www.muyunyun.cn.key  \\\n--fullchain-file  /etc/nginx/ssl/www.muyunyun.cn/fullchain.cer \\\n--reloadcmd     "service nginx force-reload"\n')),(0,c.kt)("p",null,"请一定使用以上语法 acme.sh --install-cer 进行拷贝，这样证书才能保证在新的位置也能自动更新。"),(0,c.kt)("p",null,(0,c.kt)("img",p({parentName:"p"},{src:"http://with.muyunyun.cn/922adc77ccacd8bb3c52dd9ceb8e080e.jpg",alt:null}))),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"步骤四: 将 ",(0,c.kt)("inlineCode",{parentName:"li"},"/etc/nginx/ssl/www.muyunyun.cn/")," 中的证书手动配置到 nginx, 并重启 nginx 使之生效。")),(0,c.kt)("p",null,"将 /etc/nginx/conf.d/",(0,c.kt)("a",p({parentName:"p"},{href:"http://www.muyunyun.cn.conf"}),"www.muyunyun.cn.conf")," 中的内容替换为:"),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),'server {\n    listen       80;\n    listen       [::]:80;\n    server_name  www.muyunyun.cn;\n    root         /usr/share/nginx/html/www.muyunyun.cn;\n\n    error_page 404 /404.html;\n    location = /404.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n    }\n}\n\n\nserver {\n    listen       443 ssl http2;\n    listen       [::]:443 ssl http2;\n    server_name  www.muyunyun.cn;\n    root         /usr/share/nginx/html/www.muyunyun.cn;\n\n    ssl_certificate "/etc/nginx/ssl/www.muyunyun.cn/fullchain.cer";\n    ssl_certificate_key "/etc/nginx/ssl/www.muyunyun.cn/www.muyunyun.cn.key";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers HIGH:!aNULL:!MD5;\n    ssl_prefer_server_ciphers on;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n')),(0,c.kt)("p",null,"重启 nginx:"),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"systemctl restart nginx\n")),(0,c.kt)("p",null,"打开 ",(0,c.kt)("a",p({parentName:"p"},{href:"https://www.muyunyun.cn%EF%BC%8C%E8%AF%81%E4%B9%A6%E5%B7%B2%E7%94%9F%E6%95%88%E3%80%82"}),"https://www.muyunyun.cn，证书已生效。")),(0,c.kt)("p",null,(0,c.kt)("img",p({parentName:"p"},{src:"http://with.muyunyun.cn/a397cb63269be96f1102a117bbe3fb49.jpg-400",alt:null}))),(0,c.kt)("p",null,"由于我们全程使用 acme.sh 进行安装，acme.sh 会自动为你创建一个定时任务, 每天 0:00 点自动检测所有的证书, 如果快过期了, 需要更新, 则会自动更新证书。"),(0,c.kt)("p",null,"运行 ",(0,c.kt)("inlineCode",{parentName:"p"},"ps aux | grep acme")," 可以看到 acme 一直在后台运行。"),(0,c.kt)("pre",null,(0,c.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"root@VM-16-17-ubuntu:/etc/nginx/ssl/www.muyunyun.cn# ps aux | grep acme\nroot     1561193  0.0  0.0   7348   748 pts/0    S+   03:57   0:00 grep --color=auto acme\n")),(0,c.kt)("h3",null,"相关链接"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("a",p({parentName:"li"},{href:"https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E"}),"acme.sh 使用说明"))))}o.isMDXComponent=!0}}]);