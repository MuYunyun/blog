(self.webpackChunkblog=self.webpackChunkblog||[]).push([[7234],{7234:(n,e,t)=>{"use strict";t.r(e),t.d(e,{default:()=>m});var p=t(59713),r=t.n(p),a=t(6479),l=t.n(a),u=(t(67294),t(3905));function s(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(n);e&&(p=p.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,p)}return t}function o(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?s(Object(t),!0).forEach((function(e){r()(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}var c={};function m(n){var e=n.components,t=l()(n,["components"]);return(0,u.kt)("wrapper",o(o(o({},c),t),{},{components:e,mdxType:"MDXLayout"}),(0,u.kt)("ul",null,(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8E%9F%E7%90%86%E6%9E%B6%E6%9E%84"}),"内网穿透原理架构")),(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BA%91%E4%B8%BB%E6%9C%BA-nginx-%E6%B7%BB%E5%8A%A0-http-%E6%9C%8D%E5%8A%A1"}),"服务端(云主机) nginx 添加 Http 服务")),(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#frp"}),"frp"),(0,u.kt)("ul",{parentName:"li"},(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BA%91%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"}),"服务端(云主机)配置")),(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%9C%B0%E4%BD%BF%E7%94%A8-pm2-%E8%BF%90%E8%A1%8C-frps"}),"进一步地使用 pm2 运行 frps")),(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A0%91%E8%8E%93%E6%B4%BE%E9%85%8D%E7%BD%AE"}),"客户端(树莓派)配置")))),(0,u.kt)("li",{parentName:"ul"},(0,u.kt)("a",o({parentName:"li"},{href:"#%E6%B7%BB%E5%8A%A0-ssh-%E6%9C%8D%E5%8A%A1"}),"添加 SSH 服务"))),(0,u.kt)("h3",null,"内网穿透原理架构"),(0,u.kt)("p",null,"本文中，我们使用了",(0,u.kt)("a",o({parentName:"p"},{href:"https://github.com/fatedier/frp"}),"frp"),"，frp 是一个专注于内网穿透的高性能的反向代理应用。"),(0,u.kt)("p",null,"todo: 补充流程图。"),(0,u.kt)("h3",null,"服务端(云主机) nginx 添加 Http 服务"),(0,u.kt)("p",null,"首先将域名控制台(本文中使用 frp.muyunyun.cn 域名作为演示)解析到服务器 ip。"),(0,u.kt)("p",null,"为了方面后续的调试运行，需放开以下几个服务器端口。"),(0,u.kt)("ul",null,(0,u.kt)("li",{parentName:"ul"},"80 端口:（Nginx 接收 http 请求用）"),(0,u.kt)("li",{parentName:"ul"},"6000 端口:（转发映射 SSH 服务用）"),(0,u.kt)("li",{parentName:"ul"},"8080 端口:（转发映射 http 服务用）"),(0,u.kt)("li",{parentName:"ul"},"7000 端口:（服务器端 frps 运行端口）")),(0,u.kt)("p",null,"以配置域名 frp.muyunyun.cn 为例，，转发对 ",(0,u.kt)("inlineCode",{parentName:"p"},"frp.muyunyun.cn")," 域名请求到 ",(0,u.kt)("inlineCode",{parentName:"p"},"8080 端口"),"。"),(0,u.kt)("blockquote",null,(0,u.kt)("p",{parentName:"blockquote"},"参考 ",(0,u.kt)("a",o({parentName:"p"},{href:"https://muyunyun.cn/blog/yq9jpwrw"}),"nginx 常用命令"),"安装 Nginx。")),(0,u.kt)("p",null,"新建配置文件:"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"touch /etc/nginx/conf.d/frp.muyunyun.cn.conf\n")),(0,u.kt)("p",null,"在配置文件中添加 http 服务相关内容:"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),'server {\n    server_name      frp.muyunyun.cn;\n    listen           80;\n    listen           [::]:80;\n    root             /usr/share/nginx/html/frp.muyunyun.cn;\n\n    location / {\n        # 这里先预留 8080 端口，在后文章节[基于树莓派搭建家庭服务器](https://muyunyun.cn/blog/r4zxdn6n) 中会在 8080 端口上启动 Web 服务。\n        proxy_pass http://127.0.0.1:8080;\n        proxy_set_header Host $host:80;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n\n# 以下配置用于 Https, 若读者后续有配置 Https 的需求时可再折回参考如下配置，参考 [HTTPS 协议配置](https://muyunyun.cn/blog/mx5pvgl1)。\nserver {\n    listen       443 ssl http2;\n    listen       [::]:443 ssl http2;\n    server_name  frp.muyunyun.cn;\n    root         /usr/share/nginx/html/frp.muyunyun.cn;\n\n    location / {\n        proxy_pass http://127.0.0.1:8080;\n        proxy_set_header Host $host:443;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    ssl_certificate "/etc/nginx/ssl/frp.muyunyun.cn/fullchain.cer";\n    ssl_certificate_key "/etc/nginx/ssl/frp.muyunyun.cn/frp.muyunyun.cn.key";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers HIGH:!aNULL:!MD5;\n    ssl_prefer_server_ciphers on;\n\n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n')),(0,u.kt)("blockquote",null,(0,u.kt)("p",{parentName:"blockquote"},"端口使用 80 页面会提示",(0,u.kt)("inlineCode",{parentName:"p"},"网站暂时无法访问，该网站未根据工信部相关法律规则进行备案"),"(与二级域名无关，比如使用 ",(0,u.kt)("a",o({parentName:"p"},{href:"http://www.muyunyun.cn"}),"www.muyunyun.cn")," 或者 frp.muyunyun.cn 都行)，",(0,u.kt)("a",o({parentName:"p"},{href:"https://icp-faq.dnspod.cn/why"}),"了解更多备案相关内容"),"。如果未备案，可以将它修改 80 端口为其它端口，比如 90 端口。如果后续要使用 acme.sh 申请 https 服务，还是需要用 80 端口。")),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/04afbf893d08548ebd06a85488389298.jpg-400",alt:null}))),(0,u.kt)("p",null,"新建 ",(0,u.kt)("inlineCode",{parentName:"p"},"frp.muyunyun.cn")," 对应的网站文件夹与文件"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"mkdir -p /usr/share/nginx/html/frp.muyunyun.cn\ntouch /usr/share/nginx/html/frp.muyunyun.cn/index.html\n")),(0,u.kt)("p",null,"在 ",(0,u.kt)("inlineCode",{parentName:"p"},"/usr/share/nginx/html/fpr.muyunyun.cn/index.html")," 中输入"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-html"}),'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>云随风</title>\n</head>\n<body>Test</body>\n</html>\n')),(0,u.kt)("p",null,"控制台输入 ",(0,u.kt)("inlineCode",{parentName:"p"},"sudo systemctl restart nginx"),"。"),(0,u.kt)("p",null,"此时在浏览器访问 ",(0,u.kt)("a",o({parentName:"p"},{href:"http://frp.muyunyun.cn"}),"http://frp.muyunyun.cn")," 可以看到目标内容:"),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/4373b2aaca032ed2a78fac53279532d2.jpg",alt:null}))),(0,u.kt)("h3",null,"frp"),(0,u.kt)("h4",null,"服务端(云主机)配置"),(0,u.kt)("p",null,"在云主机端执行如下命令:"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"cd /opt/\nsudo wget https://github.com/fatedier/frp/releases/download/v0.37.0/frp_0.37.0_linux_386.tar.gz\nsudo tar zxvf frp_0.37.0_linux_386.tar.gz\n")),(0,u.kt)("p",null,"进入 ",(0,u.kt)("inlineCode",{parentName:"p"},"/opt/frp_0.37.0_linux_arm64")),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/32f4ce6995482f6e086b85d2bdd06a01.jpg",alt:null}))),(0,u.kt)("p",null,"备份服务端 frps 的配置文件 frps.ini"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"sudo cp frps.ini frps.ini_backup\n")),(0,u.kt)("p",null,"修改服务端配置文件 frps.ini，增加一行 ",(0,u.kt)("inlineCode",{parentName:"p"},"vhost_http_port = 8080"),":"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-diff"}),"[common]\nbind_port = 7000\n+ vhost_http_port = 8080\n")),(0,u.kt)("p",null,"以上配置含义为: 服务端 frps 程序运行在 7000 端口，并将指向 8080 端口的请求转发到客户端。"),(0,u.kt)("p",null,"运行如下命令，开启 frp 的服务端程序"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"./frps -c frps.ini\n")),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/eb0a4e394f5b656b3e67c13c6ab1eb82.jpg",alt:null}))),(0,u.kt)("h4",null,"进一步地使用 pm2 运行 frps"),(0,u.kt)("p",null,"安装 node 环境"),(0,u.kt)("blockquote",null,(0,u.kt)("p",{parentName:"blockquote"},(0,u.kt)("a",o({parentName:"p"},{href:"https://cloud.tencent.com/document/product/213/38237#.E6.AD.A5.E9.AA.A43.EF.BC.9A.E5.AE.89.E8.A3.85-node.js-.E5.A4.9A.E7.89.88.E6.9C.AC.EF.BC.88.E5.8F.AF.E9.80.89.EF.BC.89"}),"安装 Node.js 多版本"))),(0,u.kt)("p",null,"全局安装 pm2"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"npm i pm2 -g\n")),(0,u.kt)("p",null,"使用 pm2 守护运行 frps 服务"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),'sudo echo "/opt/frp_0.37.0_linux_386/frps -c /opt/frp_0.37.0_linux_386/frps.ini" > /opt/frp_0.37.0_linux_386/start_frpc.sh\npm2 start /opt/frp_0.37.0_linux_386/start_frps.sh\npm2 save\n')),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/e52ef19b14366896e5de3c6bf7bce609.jpg",alt:null}))),(0,u.kt)("h4",null,"客户端(树莓派)配置"),(0,u.kt)("p",null,"在树莓派内执行以下命令，下载 frp，并解压。"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"cd /opt/\nsudo wget https://github.com/fatedier/frp/releases/download/v0.37.0/frp_0.37.0_linux_arm64.tar.gz\nsudo tar zxvf frp_0.37.0_linux_arm64.tar.gz\n")),(0,u.kt)("p",null,"进入 ",(0,u.kt)("inlineCode",{parentName:"p"},"/opt/frp_0.37.0_linux_arm64")),(0,u.kt)("p",null,"备份客户端 frpc 的配置文件 frpc.ini"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"sudo cp frpc.ini frpc.ini_backup\n")),(0,u.kt)("p",null,"frpc.ini 文件备份如下:"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"[common]\nserver_addr = 127.0.0.1\nserver_port = 7000\n\n[ssh]\ntype = tcp\nlocal_ip = 127.0.0.1\nlocal_port = 22\nremiote_port = 6000\n")),(0,u.kt)("p",null,"编辑 frpc.ini:"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"sudo vim frpc.ini\n")),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"[common]\nserver_addr = 81.69.252.246\nserver_port = 7000\n\n[web]\ntype = http\nlocal_port = 8080\ncustom_domains = frp.muyunyun.cn\n")),(0,u.kt)("p",null,"启动客户端"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"./frpc -c frpc.ini\n")),(0,u.kt)("p",null,"接着从公网访问 frp.muyunyun.cn，验证内网穿透是否成功。"),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/c61981adbdaba27efbc45b26c1921891.jpg-400",alt:null}))),(0,u.kt)("p",null,"可以看到来自公网的请求在树莓派的 frp 客户端已经有了反应，接着我们在树莓派搭建一个简单服务。"),(0,u.kt)("blockquote",null,(0,u.kt)("p",{parentName:"blockquote"},"进一步地，可以参考 ",(0,u.kt)("a",o({parentName:"p"},{href:"https://muyunyun.cn/blog/r4zxdn6n"}),"基于树莓派搭建家庭服务器"),"。")),(0,u.kt)("h3",null,"添加 SSH 服务"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"[ssh]\ntype = tcp\nlocal_ip = 127.0.0.1\nlocal_port = 22\nremote_port = 6000\n")),(0,u.kt)("p",null,"如上配置是指将树莓派的默认 ssh 的 22 号端口映射到 frp.muyunyun.cn 的 6000 端口。"),(0,u.kt)("p",null,"重启 frpc 服务:"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"cd /opt/frp_0.37.0_linux_arm64\npm2 restart start_frpc.sh\n")),(0,u.kt)("p",null,"通过公网 frp.muyunyun.cn 的 6000 端口进行 ssh 登录。"),(0,u.kt)("pre",null,(0,u.kt)("code",o({parentName:"pre"},{className:"language-bash"}),"ssh ubuntu@frp.muyunyun.cn -p 6000\n")),(0,u.kt)("p",null,(0,u.kt)("img",o({parentName:"p"},{src:"http://with.muyunyun.cn/43431e73e8a218fb9e0a494f61f8f0df.jpg",alt:null}))),(0,u.kt)("p",null,"至此实现了在公网使用 SSH 操作访问树莓派的需求。"))}m.isMDXComponent=!0}}]);