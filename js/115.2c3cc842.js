(window.webpackJsonp=window.webpackJsonp||[]).push([[115],{767:function(n,a){n.exports="[项目实现源码](https://github.com/MuYunyun/blog/tree/master/BasicSkill/node/koa)\n\n该简版 koa 的实现包含以下 4 个步骤:\n\n* http 模块的封装\n* 整合 Request、Response、Context 对象\n* 中间件\n* 错误捕获\n\n### http 模块的封装\n\nkoa 区别于 express 的一个点是其采用了 ES6 语法进行书写。\n\n[相关代码](https://github.com/MuYunyun/blog/blob/7bdad6158a6d49bc3a99123a054b0934034cc598/BasicSkill/node/koa/application.js#L17)\n\n### 整合 Request、Response、Context 对象\n\nkoa 的用法区别于 express 的一点, 是将 req, res 封装进 ctx 对象中\n\n```js\n// express\napp.get('/test/abc', function (req, res) {\n  res.end('hello express')\n})\n\n// koa\napp.use(async (ctx) => {\n  ctx.body = `hello koa`\n})\n```\n\n[相关代码](https://github.com/MuYunyun/blog/blob/7bdad6158a6d49bc3a99123a054b0934034cc598/BasicSkill/node/koa/application.js#L52)\n\n### 中间件\n\nkoa2 的中间件是基于 async 实现的, 所以一起来探究关于 async 前置知识点:\n\n```js\nasync function m1(next) {\n  console.log('m1')\n  await next()\n}\n\nasync function m2(next) {\n  console.log('m2')\n  await next()\n}\n\nasync function m3() {\n  console.log('m3')\n}\n```\n\n如何将 m1, m2, m3 串联起来呢？\n\n```js\nvar next1 = async function() {\n  await m2(next2)\n}\n\nvar next2 = async function() {\n  await m3()\n}\n\nm1(next1)\n```\n\n接着将以上函数进行抽象:\n\n```js\nvar createAsync = function(fn, next) {\n  return async function() {\n    await fn(next)\n  }\n}\n\nvar next3 = createAsync(m3, null)\nvar next2 = createAsync(m2, next3)\nvar next1 = createAsync(m1, next2)\n\nnext1()\n```\n\n再尝试优化:\n\n```js\nvar arr = [m1, m2, m3]\nvar next\n\nfor (let i = arr.length - 1; i > 0; i--) {\n  next = createAsync(arr[i], next)\n}\n\nnext()\n```\n\n在上篇 express 的实现中, [中间件](https://github.com/MuYunyun/blog/blob/7bdad6158a6d49bc3a99123a054b0934034cc598/BasicSkill/node/express/index.js#L55) 采用了 generator 来实现, 而本篇 koa 则使用了上文所述的 async/await 知识点来完成。\n\n[相关代码](https://github.com/MuYunyun/blog/blob/7bdad6158a6d49bc3a99123a054b0934034cc598/BasicSkill/node/koa/application.js#L25)\n\n### 错误捕获\n\n此外完善的框架都有相应的错误捕获机制, 因此当程序 `throw new Error()` 抛错时, 也进行了相应的错误捕获, [相关代码](https://github.com/MuYunyun/blog/blob/7bdad6158a6d49bc3a99123a054b0934034cc598/BasicSkill/node/koa/application.js#L70)"}}]);